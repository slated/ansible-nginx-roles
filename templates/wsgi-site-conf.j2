#jinja2: lstrip_blocks: True
# define upstream endpoints
# uwsgi - handles HTTP requests - django
upstream {{ nginx_wsgi_app }}-wsgi {
    {{ nginx_load_balancing_algorithm | default("ip_hash") }};
    {% for server in nginx_wsgi_servers %}
      server {{ server }}:{{ nginx_wsgi_port }};
    {% endfor %}
    {% for server in nginx_wsgi_servers_heavy %}
      server {{ server }}:{{ nginx_wsgi_port }};
    {% endfor %}
}

upstream {{ nginx_wsgi_app }}-wsgi-heavy {
    {{ nginx_load_balancing_algorithm | default("ip_hash") }};
    {% for server in nginx_wsgi_servers_heavy %}
      server {{ server }}:{{ nginx_wsgi_port }};
    {% endfor %}
}

{% if upstream_asgi_servers %}
# asgi / Daphne - Django Channels HTTP/WebSocket server
upstream {{ nginx_wsgi_app }}-asgi {
    {{ nginx_load_balancing_algorithm | default("ip_hash") }};
    {% for server in nginx_wsgi_servers %}
      server {{ server }}:{{ nginx_asgi_port }};
    {% endfor %}
}
{% endif %}

# combined + upstream metrics
log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                         '"$request" $status $body_bytes_sent '
                         '"$http_referer" "$http_user_agent" '
                         'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';

# Drop requests for unknown hosts
server {
    listen  80 default_server;
    listen 443 default_server ssl;

    access_log {{ nginx_log_dir }}/{{ nginx_server_name }}_access.log;
    error_log  {{ nginx_log_dir }}/{{ nginx_server_name }}_error.log;

    # SSL config
    {% if nginx_use_letsencrypt %}
    ssl_certificate     {{ letsencrypt_dir }}/{{ letsencrypt_cert_filename|default('fullchain.pem') }};
    ssl_certificate_key {{ letsencrypt_dir }}/{{ letsencrypt_privkey_filename|default('privkey.pem') }};
    {% else %}
    ssl_certificate      {{ nginx_ssl_dest_dir }}/{{ nginx_server_name }}.crt;
    ssl_certificate_key  {{ nginx_ssl_dest_dir }}/{{ nginx_server_name }}.key;
    {% endif %}
    ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache    shared:SSL:10m;
    ssl_session_timeout  10m;
    ssl_ciphers {{ nginx_ssl_ciphers }};
    ssl_prefer_server_ciphers on;
    # stronger key for key-exchange (Diffie Hellman)
    {% if nginx_strong_dh_group %}
    ssl_dhparam          /etc/ssl/certs/dhparams.pem;
    {% endif %}

    # return 'no response' for unknown hosts
    return 444;
}

# redirect from HTTP to HTTPS
server {
    listen 80;
    server_name {{ nginx_server_name }} www.{{ nginx_server_name }};

    access_log {{ nginx_log_dir }}/{{ nginx_server_name }}_access.log;
    error_log  {{ nginx_log_dir }}/{{ nginx_server_name }}_error.log;

    return 301 https://$host$request_uri;
}

# Handle HTTPS for server
server {
    listen 443 ssl http2;
    server_name {{ nginx_server_name }} www.{{ nginx_server_name }};
    client_max_body_size  32M;
    uwsgi_read_timeout    900s;
    keepalive_timeout     300s; # Use a higher keepalive timeout to reduce the need for repeated handshakes

    access_log {{ nginx_log_dir }}/{{ nginx_server_name }}_access.log upstream_time;
    error_log  {{ nginx_log_dir }}/{{ nginx_server_name }}_error.log;

    # SSL config
    {% if nginx_use_letsencrypt %}
    ssl_certificate     {{ letsencrypt_dir }}/{{ letsencrypt_cert_filename|default('fullchain.pem') }};
    ssl_certificate_key {{ letsencrypt_dir }}/{{ letsencrypt_privkey_filename|default('privkey.pem') }};
    {% else %}
    ssl_certificate      {{ nginx_ssl_dest_dir }}/{{ nginx_server_name }}.crt;
    ssl_certificate_key  {{ nginx_ssl_dest_dir }}/{{ nginx_server_name }}.key;
    {% endif %}
    ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache    shared:SSL:10m;
    ssl_session_timeout  24h;
    ssl_ciphers {{ nginx_ssl_ciphers }};
    ssl_prefer_server_ciphers on;

    # stronger key for key-exchange (Diffie Hellman)
    {% if nginx_strong_dh_group %}
    ssl_dhparam          /etc/ssl/certs/dhparams.pem;
    {% endif %}

    # HSTS header to tell web browsers that the site should be accessed trough https only (valid 1 year)
    add_header Strict-Transport-Security max-age=31536000;

    # LOCATIONS
    # default location
    location / {
        {% if nginx_maintenance %}
        # maintenance page short-circuit
        if (-f {{ nginx_static_dir }}/static/maintenance_page/index.html) {
            return 503;
        }
        {% endif %}

        proxy_redirect      off;
        proxy_set_header    Host                  $http_host;
        proxy_set_header    X-Real-IP             $remote_addr;
        proxy_set_header    X-Forwarded-For       $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol  $scheme;

        # Varnish proxy
        proxy_pass      http://127.0.0.1:6081/;
    }

{% if upstream_asgi_servers %}
    # websockets / daphne
    location = /websocket/ {
        proxy_pass          http://{{ nginx_wsgi_app }}-asgi;
        proxy_http_version  1.1;

        proxy_set_header    Host            $http_host;
        proxy_set_header    Upgrade         $http_upgrade;
        proxy_set_header    Connection      "upgrade";
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

        allow all;
        auth_basic off;

        # Prevents 502 bad gateway error
        proxy_buffering off;
        proxy_buffers 8 32k;
        proxy_buffer_size 64k;
    }
{% endif %}

{% if nginx_serve_media %}
    # django uploaded content
    location /media/ {
        alias           {{ nginx_media_dir }}/;
        autoindex       off;
    }
{% endif %}

{% if nginx_serve_static %}
    # django static assests (.css, .js)
    location /static/ {
        root            {{ nginx_static_dir }}/;
        autoindex       off;
        access_log      off;
        log_not_found   on;
        expires         7d;
    }

    location /robots.txt {
        root            {{ nginx_static_dir }}/;
        access_log      off;
        log_not_found   off;
        expires         1h;
    }

    location /favicon.ico {
        root            {{ nginx_static_dir }}/;
        access_log      off;
        log_not_found   off;
        expires         7d;
    }
{% endif %}


    # error handling
    error_page 503 /maintenance_page/index.html;
    error_page 403 /403.html;

    location = /maintenance_page/index.html {
        root {{ nginx_static_dir }}/static/;
    }

    location = /403.html {
        root {{ nginx_static_dir }}/;
    }

{% for proxy in nginx_http_proxies %}
    # PROXIES
    # flower (celery monitor), maillog
    location /{{ proxy.path }}/ {
        rewrite ^/{{ proxy.path }}/(.*)$ /$1 break;
        proxy_pass http://{{ proxy.address }}:{{ proxy.port }};
        proxy_set_header Host $host;
        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        access_log off;

        {% if nginx_restricted_auth %}
        auth_basic "Restricted Content";
        auth_basic_user_file {{ nginx_restricted_file_path }};
        {% endif %}
    }
{% endfor %}

{% if nginx_restricted_auth and nginx_restricted_auth_all %}
    # user authentication - site wide
    auth_basic "Restricted Content";
    auth_basic_user_file {{ nginx_restricted_file_path }};
{% endif %}

}

server {
    listen      127.0.0.1:8080;

    # LOCATIONS
    # default location
    location / {

        proxy_redirect      off;
        proxy_set_header    Host                  $http_host;
        proxy_set_header    X-Real-IP             $remote_addr;
        proxy_set_header    X-Forwarded-For       $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol  $scheme;

        # pass request to uwsgi
        uwsgi_pass {{ nginx_wsgi_app }}-wsgi;
        uwsgi_read_timeout 30s;
        uwsgi_send_timeout 30s;
        include uwsgi_params;
    }

    location ~ "/api/v[0-9].+/source" {

        proxy_redirect      off;
        proxy_set_header    Host                  $http_host;
        proxy_set_header    X-Real-IP             $remote_addr;
        proxy_set_header    X-Forwarded-For       $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol  $scheme;

        # pass request to uwsgi
        uwsgi_pass {{ nginx_wsgi_app }}-wsgi-heavy;
        uwsgi_read_timeout 300s;
        uwsgi_send_timeout 300s;
        include uwsgi_params;
    }

    location ~ "/api/v[0-9].+/(productions|persons|businesses)/search/deep" {

        proxy_redirect      off;
        proxy_set_header    Host                  $http_host;
        proxy_set_header    X-Real-IP             $remote_addr;
        proxy_set_header    X-Forwarded-For       $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol  $scheme;

        # pass request to uwsgi
        uwsgi_pass {{ nginx_wsgi_app }}-wsgi-heavy;
        uwsgi_read_timeout 300s;
        uwsgi_send_timeout 300s;
        include uwsgi_params;
    }

    location ~ "/api/v[0-9].+/(persons|businesses)/[^/]+/scores" {

        proxy_redirect      off;
        proxy_set_header    Host                  $http_host;
        proxy_set_header    X-Real-IP             $remote_addr;
        proxy_set_header    X-Forwarded-For       $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol  $scheme;

        # pass request to uwsgi
        uwsgi_pass {{ nginx_wsgi_app }}-wsgi-heavy;
        uwsgi_read_timeout 300s;
        uwsgi_send_timeout 300s;
        include uwsgi_params;
    }

    location /sl8dmin {

        proxy_redirect      off;
        proxy_set_header    Host                  $http_host;
        proxy_set_header    X-Real-IP             $remote_addr;
        proxy_set_header    X-Forwarded-For       $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol  $scheme;

        # pass request to uwsgi
        uwsgi_pass {{ nginx_wsgi_app }}-wsgi-heavy;
        uwsgi_read_timeout 300s;
        uwsgi_send_timeout 300s;
        include uwsgi_params;
    }
}
